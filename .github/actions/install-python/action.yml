name: Install Python
description: Action for installing Python and Poetry

inputs:
  PYTHON_VERSION:
    description: "Version of Python to install"
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.PYTHON_VERSION }}

    - name: Load Cached pyenv
      id: pyenv-cache
      uses: actions/cache@v3
      with:
        path: /home/runner/.pyenv/
        key: pyenv-${{ runner.os }}-${{ inputs.PYTHON_VERSION }}

    - name: Install pyenv
      if: steps.pyenv-cache.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/pyenv/pyenv.git ~/.pyenv
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
        echo 'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
        echo 'eval "$(pyenv init -)"' >> ~/.bashrc        
      shell: bash

    - name: Install poetry
      run: |
        pip3 install --upgrade poetry
        poetry config virtualenvs.in-project true
      shell: bash

    - name: Load Cached Virtualenv
      id: venv-cache
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ inputs.PYTHON_VERSION }}-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/poetry.lock') }}

    - name: Install dependencies and project in dev mode
      if: steps.venv-cache.outputs.cache-hit != 'true'
      run: make install
      shell: bash
